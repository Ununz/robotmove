<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Teacher Command Console</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <style>
    *,
    *::before,
    *::after {
      box-sizing: border-box;
    }

    :root {
      --color-surface: rgba(255,255,255,0.92);
      --color-surface-strong: rgba(255,255,255,0.98);
      --color-border: rgba(148,163,184,0.28);
      --color-border-strong: rgba(99,102,241,0.35);
      --color-primary: #4f46e5;
      --color-primary-dark: #4338ca;
      --color-accent: #0ea5e9;
      --color-success: #22c55e;
      --color-warning: #f59e0b;
      --color-danger: #f43f5e;
      --color-muted: #64748b;
      --shadow-lg: 0 34px 60px -42px rgba(15,23,42,0.62);
      --shadow-md: 0 26px 42px -36px rgba(15,23,42,0.55);
      --shadow-soft: 0 16px 30px -26px rgba(15,23,42,0.32);
      --radius-xl: 22px;
      --radius-lg: 18px;
      --radius-md: 14px;
      --radius-sm: 12px;
      --radius-pill: 999px;
    }

    body {
      margin: 0;
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      color: #0f172a;
      background: #eef2ff;
      min-height: 100vh;
      position: relative;
      line-height: 1.45;
    }

    .background-canvas {
      position: fixed;
      inset: 0;
      background:
        radial-gradient(circle at 18% 22%, rgba(79,70,229,0.22), transparent 55%),
        radial-gradient(circle at 78% 12%, rgba(14,165,233,0.2), transparent 58%),
        radial-gradient(circle at 55% 82%, rgba(16,185,129,0.2), transparent 58%),
        #e8ecff;
      z-index: -2;
    }

    .background-canvas::after {
      content: '';
      position: absolute;
      inset: 0;
      background-image: linear-gradient(180deg, rgba(255,255,255,0.22) 0%, rgba(255,255,255,0));
      mask-image: linear-gradient(180deg, rgba(0,0,0,0.6), transparent 65%);
    }

    .dashboard {
      width: min(1440px, 100%);
      margin: 0 auto;
      padding: 48px 48px 72px;
    }

    @media (max-width: 1280px) {
      .dashboard {
        padding: 42px 32px 64px;
      }
    }

    @media (max-width: 1024px) {
      .dashboard {
        padding: 32px 24px 56px;
      }
    }

    .glass {
      backdrop-filter: blur(14px);
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-lg);
    }

    .hero {
      position: relative;
      overflow: hidden;
      background: linear-gradient(135deg, rgba(79,70,229,0.95), rgba(14,165,233,0.92));
      color: #f8fafc;
    }

    .hero::before {
      content: '';
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at top right, rgba(255,255,255,0.28), transparent 62%);
      opacity: 0.85;
    }

    .dashboard__header {
      padding: 36px 42px 40px;
      display: grid;
      grid-template-columns: 1.8fr 1fr;
      gap: 36px;
      position: relative;
      z-index: 1;
    }

    @media (max-width: 1024px) {
      .dashboard__header {
        grid-template-columns: 1fr;
        gap: 28px;
      }
    }

    .hero__content {
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    .hero__eyebrow {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      border-radius: var(--radius-pill);
      background: rgba(15,23,42,0.3);
      font-size: 0.74rem;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      font-weight: 600;
    }

    .hero__title {
      font-size: clamp(2rem, 1.2vw + 1.8rem, 2.9rem);
      font-weight: 700;
      margin: 0;
    }

    .hero__status {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 10px 18px;
      border-radius: var(--radius-pill);
      background: rgba(15,23,42,0.28);
      font-size: 0.86rem;
      font-weight: 500;
    }

    .hero__status-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #4ade80;
      box-shadow: 0 0 0 0 rgba(74,222,128,0.8);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(74,222,128,0.8); }
      70% { box-shadow: 0 0 0 12px rgba(74,222,128,0); }
      100% { box-shadow: 0 0 0 0 rgba(74,222,128,0); }
    }

    .hero__metrics {
      display: grid;
      gap: 18px;
      align-content: start;
    }

    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 16px;
    }

    @media (max-width: 540px) {
      .metrics-grid {
        grid-template-columns: 1fr;
      }
    }

    .metric-card {
      border-radius: var(--radius-lg);
      padding: 20px 22px;
      background: rgba(15,23,42,0.32);
      backdrop-filter: blur(6px);
      border: 1px solid rgba(255,255,255,0.14);
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .metric-card__label {
      font-size: 0.75rem;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: rgba(226,232,240,0.78);
      font-weight: 600;
    }

    .metric-card__value {
      font-size: 2rem;
      font-weight: 700;
    }

    .metric-card__sub {
      font-size: 0.88rem;
      color: rgba(226,232,240,0.86);
    }

    .dashboard__body {
      margin-top: 36px;
      display: grid;
      grid-template-columns: 320px 300px minmax(0, 1fr);
      gap: 28px;
      align-items: flex-start;
    }

    @media (max-width: 1280px) {
      .dashboard__body {
        grid-template-columns: 280px 280px minmax(0, 1fr);
      }
    }

    @media (max-width: 1024px) {
      .dashboard__body {
        grid-template-columns: 1fr;
      }
    }

    .panel {
      display: flex;
      flex-direction: column;
      gap: 18px;
      padding: 22px 22px;
      position: relative;
      border-radius: var(--radius-xl);
      height: 100%;
    }

    .panel__header {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .panel__title {
      margin: 0;
      font-size: 1.16rem;
      font-weight: 700;
      color: #0f172a;
    }

    .panel__subtitle {
      margin: 0;
      font-size: 0.88rem;
      color: var(--color-muted);
    }

    .connection-panel {
      margin-top: 24px;
      padding: 20px 22px;
      display: grid;
      grid-template-columns: 1fr;
      gap: 20px;
      align-items: flex-start;
      background: var(--color-surface-strong);
    }

    .connection-panel__header {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .connection-panel__title {
      margin: 0;
      font-size: 1.12rem;
      font-weight: 700;
      color: #0f172a;
    }

    .connection-panel__subtitle {
      margin: 0;
      font-size: 0.82rem;
      color: var(--color-muted);
      line-height: 1.4;
    }

    .connection-panel__status {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: var(--radius-pill);
      background: rgba(15,23,42,0.08);
      font-size: 0.72rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      font-weight: 700;
      color: var(--color-muted);
    }

    .connection-panel__status.is-ready {
      background: rgba(34,197,94,0.18);
      color: #047857;
    }

    .connection-panel__status.is-stale {
      background: rgba(249,115,22,0.16);
      color: #9a3412;
    }

    .connection-panel__status.is-empty {
      background: rgba(15,23,42,0.08);
      color: var(--color-muted);
    }

    .connection-panel__form {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 16px 18px;
    }

    .form-field {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .form-field.full {
      grid-column: 1 / -1;
    }

    .form-label {
      font-size: 0.76rem;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      font-weight: 700;
      color: var(--color-muted);
    }

    .form-input {
      border-radius: var(--radius-md);
      border: 1px solid rgba(148,163,184,0.45);
      padding: 10px 12px;
      font-size: 0.9rem;
      transition: border-color 0.2s, box-shadow 0.2s;
      background: rgba(255,255,255,0.94);
    }

    .form-input:focus {
      outline: none;
      border-color: var(--color-primary);
      box-shadow: 0 0 0 3px rgba(79,70,229,0.16);
    }

    .form-actions {
      display: flex;
      align-items: center;
      gap: 10px;
      grid-column: 1 / -1;
      margin-top: 2px;
      flex-wrap: wrap;
    }

    .connection-panel__footnote {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      justify-content: space-between;
      grid-column: 1 / -1;
      font-size: 0.75rem;
      color: var(--color-muted);
    }

    .connection-panel__reset {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      color: var(--color-primary-dark);
      font-weight: 600;
      cursor: pointer;
    }

    @media (max-width: 1080px) {
      .connection-panel {
        padding: 18px;
      }
    }

    .section-label {
      font-size: 0.76rem;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      font-weight: 700;
      color: var(--color-muted);
    }

    .teams-panel {
      gap: 18px;
    }

    .search-field {
      position: relative;
    }

    .search-field input {
      width: 100%;
      padding: 12px 16px 12px 42px;
      border-radius: var(--radius-md);
      border: 1px solid rgba(148,163,184,0.45);
      background: var(--color-surface-strong);
      font-size: 0.95rem;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    .search-field input:focus {
      outline: none;
      border-color: var(--color-primary);
      box-shadow: 0 0 0 3px rgba(79,70,229,0.18);
    }

    .search-field .bi-search {
      position: absolute;
      top: 50%;
      left: 16px;
      transform: translateY(-50%);
      color: var(--color-muted);
      font-size: 1rem;
    }

    .teams-panel__filters {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .filter-pill {
      padding: 8px 16px;
      border-radius: var(--radius-pill);
      border: 1px solid rgba(99,102,241,0.22);
      background: rgba(99,102,241,0.08);
      font-size: 0.78rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--color-primary-dark);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      transition: background 0.2s, border-color 0.2s, color 0.2s, transform 0.2s;
    }

    .filter-pill.is-active {
      background: var(--color-primary);
      border-color: transparent;
      color: #fff;
      box-shadow: 0 18px 30px -20px rgba(79,70,229,0.65);
      transform: translateY(-1px);
    }

    .teams-panel__watchlist {
      display: flex;
      flex-direction: column;
      gap: 10px;
      background: rgba(79,70,229,0.08);
      border: 1px solid rgba(79,70,229,0.18);
      border-radius: var(--radius-lg);
      padding: 14px 16px;
    }

    .watchlist__title {
      font-size: 0.88rem;
      font-weight: 600;
      color: var(--color-primary-dark);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .watchlist__tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .watchlist-tag {
      --tag-color: var(--color-primary);
      --tag-bg: rgba(79,70,229,0.12);
      --tag-border: rgba(79,70,229,0.28);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: var(--radius-pill);
      background: var(--tag-bg);
      border: 1px solid var(--tag-border);
      color: var(--tag-color);
      font-size: 0.82rem;
      font-weight: 600;
      letter-spacing: 0.02em;
    }

    .watchlist-tag::before {
      content: '●';
      font-size: 1.05rem;
      line-height: 1;
      color: var(--tag-color);
    }

    .watchlist-tag--empty {
      --tag-color: var(--color-muted);
      --tag-bg: rgba(148,163,184,0.14);
      --tag-border: rgba(148,163,184,0.24);
      font-style: italic;
    }

    .watchlist-tag--empty::before {
      content: '◎';
      font-size: 1rem;
      color: var(--tag-color);
    }

    .watchlist__meta {
      display: flex;
      justify-content: space-between;
      font-size: 0.78rem;
      color: var(--color-muted);
      gap: 12px;
      flex-wrap: wrap;
    }

    .watchlist-clear {
      border: none;
      background: none;
      color: var(--color-primary-dark);
      font-weight: 600;
      cursor: pointer;
      padding: 0;
      text-decoration: underline transparent;
      transition: color 0.2s, text-decoration-color 0.2s;
    }

    .watchlist-clear:hover {
      color: var(--color-primary);
      text-decoration-color: currentColor;
    }

    .watchlist-clear:disabled {
      color: rgba(100,116,139,0.6);
      cursor: not-allowed;
      text-decoration: none;
    }

    .teams-panel__list {
      display: flex;
      flex-direction: column;
      gap: 14px;
      overflow-y: auto;
      max-height: none;
      padding-right: 6px;
      margin-right: -6px;
      scrollbar-width: thin;
      scrollbar-color: rgba(148,163,184,0.32) transparent;
    }

    .teams-panel__empty {
      padding: 28px 14px;
      text-align: center;
      border: 1px dashed rgba(148,163,184,0.4);
      border-radius: var(--radius-lg);
      color: var(--color-muted);
      font-size: 0.9rem;
      background: rgba(148,163,184,0.08);
    }

    .teams-panel__list::-webkit-scrollbar {
      width: 6px;
    }

    .teams-panel__list::-webkit-scrollbar-track {
      background: transparent;
    }

    .teams-panel__list::-webkit-scrollbar-thumb {
      background: rgba(148,163,184,0.45);
      border-radius: 999px;
    }

    .team-card {
      --accent: var(--color-primary);
      --card-bg: rgba(79,70,229,0.08);
      --card-border: rgba(79,70,229,0.26);
      display: flex;
      gap: 16px;
      padding: 16px 18px;
      border-radius: var(--radius-lg);
      border: 1px solid var(--card-border);
      background: var(--card-bg);
      transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s;
      cursor: pointer;
      box-shadow: var(--shadow-soft);
    }

    .team-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 20px 36px -28px rgba(15,23,42,0.35);
      border-color: var(--accent);
    }

    .team-card input[type="checkbox"] {
      appearance: none;
      position: relative;
      width: 20px;
      height: 20px;
      border-radius: 6px;
      border: 2px solid rgba(15,23,42,0.2);
      margin-top: 4px;
      background: #fff;
      transition: background 0.2s, border-color 0.2s;
    }

    .team-card input[type="checkbox"]:checked {
      background: var(--accent);
      border-color: var(--accent);
    }

    .team-card input[type="checkbox"]:checked::after {
      content: '';
      position: absolute;
      top: 3px;
      left: 6px;
      width: 6px;
      height: 10px;
      border: solid #fff;
      border-width: 0 2px 2px 0;
      transform: rotate(45deg);
    }

    .team-card__content {
      display: flex;
      flex-direction: column;
      gap: 8px;
      width: 100%;
    }

    .team-card__row {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }

    .team-card__identity {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 600;
      font-size: 1rem;
      color: var(--accent);
    }

    .team-card__status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--accent);
      box-shadow: 0 0 0 4px rgba(255,255,255,0.6);
    }

    .team-card__state {
      font-size: 0.78rem;
      font-weight: 600;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(148,163,184,0.22);
      color: #475569;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      transition: background 0.2s, color 0.2s;
    }

    .team-card__state--waiting {
      background: rgba(148,163,184,0.18);
      color: #475569;
    }

    .team-card__state--ack {
      background: rgba(59,130,246,0.22);
      color: #1e40af;
    }

    .team-card__state--done {
      background: rgba(16,185,129,0.22);
      color: #0f766e;
    }

    .team-card__state--warn {
      background: rgba(251,191,36,0.25);
      color: #92400e;
    }

    .team-card__state--dist {
      background: rgba(236,72,153,0.18);
      color: #9d174d;
    }

    .team-card__state--sys {
      background: rgba(129,140,248,0.22);
      color: #3730a3;
    }

    .team-card__state--offline {
      background: rgba(148,163,184,0.26);
      color: #334155;
    }

    .team-card__state--issue {
      background: rgba(248,113,113,0.22);
      color: #991b1b;
    }

    .team-card__state--online {
      background: rgba(34,197,94,0.18);
      color: #06603b;
    }

    .team-card__state--idle {
      background: rgba(251,191,36,0.2);
      color: #92400e;
    }

    .team-card__detail strong {
      font-weight: 600;
      color: rgba(15,23,42,0.84);
    }

    .team-card.status-idle {
      --accent: var(--color-warning);
      --card-bg: rgba(245,158,11,0.12);
      --card-border: rgba(245,158,11,0.3);
    }

    .team-card.status-error {
      --accent: var(--color-danger);
      --card-bg: rgba(244,63,94,0.12);
      --card-border: rgba(244,63,94,0.32);
    }

    .team-card.status-offline {
      --accent: #94a3b8;
      --card-bg: rgba(148,163,184,0.14);
      --card-border: rgba(148,163,184,0.3);
      opacity: 0.85;
    }

    .teams-panel__footer {
      font-size: 0.78rem;
      color: var(--color-muted);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .teams-panel__footer a {
      color: var(--color-primary-dark);
      font-weight: 600;
      text-decoration: none;
    }

    .teams-panel__footer a:hover {
      text-decoration: underline;
    }

    .command-panel {
      gap: 18px;
      background: var(--color-surface-strong);
      display: flex;
      flex-direction: column;
    }

    .command-panel__content {
      display: grid;
      gap: 18px;
    }

    .command-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 18px;
      align-items: start;
    }

    .command-card {
      background: rgba(255,255,255,0.92);
      border-radius: var(--radius-lg);
      border: 1px solid rgba(148,163,184,0.28);
      padding: 22px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      box-shadow: var(--shadow-soft);
    }

    .command-card__header {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .command-card__title {
      margin: 0;
      font-size: 1.02rem;
      font-weight: 700;
      color: #0f172a;
    }

    .command-card__subtitle {
      margin: 0;
      font-size: 0.85rem;
      color: var(--color-muted);
    }

    .command-card__subtitle strong {
      color: var(--color-primary-dark);
    }

    .command-card__note {
      font-size: 0.8rem;
      color: #475569;
      background: rgba(99,102,241,0.08);
      border-radius: var(--radius-md);
      padding: 10px 12px;
      line-height: 1.45;
    }

    .command-card__input {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .command-card__input .form-input {
      flex: 1;
      min-width: 180px;
    }

    .command-card__actions {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
    }

    .command-card__meta {
      font-size: 0.78rem;
      color: var(--color-muted);
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      border: none;
      border-radius: var(--radius-md);
      padding: 12px 18px;
      font-weight: 600;
      font-size: 0.92rem;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s, filter 0.2s;
      white-space: nowrap;
    }

    .btn:active {
      transform: translateY(1px);
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }

    .btn--primary {
      background: linear-gradient(135deg, var(--color-primary-dark), var(--color-primary));
      color: #fff;
      box-shadow: 0 18px 34px -24px rgba(79,70,229,0.75);
    }

    .btn--primary:hover {
      filter: brightness(1.05);
    }

    .btn--accent {
      background: linear-gradient(135deg, #0ea5e9, #22d3ee);
      color: #0f172a;
      box-shadow: 0 18px 32px -24px rgba(14,165,233,0.7);
    }

    .btn--ghost {
      border: 1px solid rgba(148,163,184,0.45);
      background: #fff;
      color: var(--color-muted);
    }

    .command-card__chips,
    .command-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .command-chip {
      padding: 8px 14px;
      border-radius: var(--radius-pill);
      background: rgba(15,23,42,0.08);
      font-size: 0.8rem;
      font-weight: 600;
      color: rgba(15,23,42,0.76);
      border: 1px solid rgba(148,163,184,0.2);
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s, background 0.2s;
    }

    .command-chip:hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 24px -18px rgba(15,23,42,0.3);
      background: rgba(79,70,229,0.12);
    }

    .selected-summary {
      border-radius: var(--radius-lg);
      border: 1px solid rgba(79,70,229,0.18);
      background: rgba(79,70,229,0.06);
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .selected-summary__title {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--color-primary-dark);
    }

    .selected-summary__list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      font-size: 0.82rem;
      color: #0f172a;
    }

    .selected-summary__item {
      padding: 4px 10px;
      border-radius: var(--radius-pill);
      background: rgba(255,255,255,0.8);
      border: 1px solid rgba(79,70,229,0.2);
      font-weight: 600;
    }

    .command-card--timeline {
      grid-column: 1 / -1;
    }

    .command-feedback {
      border-radius: var(--radius-lg);
      padding: 16px 18px;
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 0.9rem;
      border: 1px solid transparent;
      margin-top: -6px;
    }

    .command-feedback i {
      font-size: 1.1rem;
    }

    .command-feedback.is-hidden {
      display: none;
    }

    .command-feedback--info {
      background: rgba(99,102,241,0.1);
      border-color: rgba(99,102,241,0.35);
      color: #312e81;
    }

    .command-feedback--success {
      background: rgba(34,197,94,0.12);
      border-color: rgba(34,197,94,0.32);
      color: #166534;
    }

    .command-feedback--warn {
      background: rgba(249,115,22,0.12);
      border-color: rgba(249,115,22,0.32);
      color: #9a3412;
    }

    .timeline {
      position: relative;
      padding-left: 18px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      max-height: 260px;
      overflow-y: auto;
      padding-right: 6px;
      scrollbar-width: thin;
      scrollbar-color: rgba(148,163,184,0.32) transparent;
    }

    .timeline::before {
      content: '';
      position: absolute;
      top: 6px;
      bottom: 6px;
      left: 6px;
      width: 2px;
      background: rgba(148,163,184,0.4);
    }

    .timeline-event {
      position: relative;
      padding-left: 14px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .timeline-event::before {
      content: '';
      position: absolute;
      top: 4px;
      left: -18px;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #fff;
      border: 3px solid var(--color-primary);
      box-shadow: 0 0 0 4px rgba(79,70,229,0.18);
    }

    .timeline-event--ack::before {
      border-color: var(--color-accent);
      box-shadow: 0 0 0 4px rgba(14,165,233,0.18);
    }

    .timeline-event--done::before {
      border-color: var(--color-success);
      box-shadow: 0 0 0 4px rgba(34,197,94,0.2);
    }

    .timeline-event--alert::before {
      border-color: var(--color-warning);
      box-shadow: 0 0 0 4px rgba(245,158,11,0.2);
    }

    .timeline::-webkit-scrollbar {
      width: 5px;
    }

    .timeline::-webkit-scrollbar-track {
      background: transparent;
    }

    .timeline::-webkit-scrollbar-thumb {
      background: rgba(148,163,184,0.38);
      border-radius: 999px;
    }

    .timeline-event__time {
      font-size: 0.75rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--color-muted);
      font-weight: 600;
    }

    .timeline-event__body {
      font-size: 0.9rem;
      color: #0f172a;
    }

    .log-panel {
      gap: 18px;
    }

    .log-panel__header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 18px;
      flex-wrap: wrap;
    }

    .log-panel__title h2 {
      margin: 0;
      font-size: 1.2rem;
      font-weight: 700;
      color: #0f172a;
    }

    .log-panel__title p {
      margin: 4px 0 0;
      font-size: 0.86rem;
      color: var(--color-muted);
    }

    .log-panel__controls {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    .toggle {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      font-size: 0.86rem;
      color: var(--color-muted);
      font-weight: 600;
    }

    .toggle input {
      display: none;
    }

    .toggle-switch {
      width: 46px;
      height: 24px;
      border-radius: var(--radius-pill);
      background: #e2e8f0;
      position: relative;
      transition: background 0.2s;
    }

    .toggle-switch::after {
      content: '';
      position: absolute;
      top: 3px;
      left: 4px;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: #fff;
      box-shadow: 0 6px 14px rgba(15,23,42,0.18);
      transition: transform 0.2s;
    }

    .toggle input:checked + .toggle-switch {
      background: var(--color-primary);
    }

    .toggle input:checked + .toggle-switch::after {
      transform: translateX(20px);
    }

    .log-panel__actions {
      display: inline-flex;
      align-items: center;
      gap: 10px;
    }

    .icon-button {
      width: 38px;
      height: 38px;
      border-radius: var(--radius-md);
      border: 1px solid rgba(148,163,184,0.4);
      background: #fff;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      color: var(--color-muted);
      cursor: pointer;
      transition: color 0.2s, border-color 0.2s, transform 0.2s;
    }

    .icon-button:hover {
      color: var(--color-primary);
      border-color: var(--color-primary);
      transform: translateY(-1px);
    }

    .log-panel__watchlist {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }

    .log-panel__watchlist-label {
      font-size: 0.78rem;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      font-weight: 700;
      color: var(--color-muted);
    }

    .log-panel__watchlist-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    .log-filter-group {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }

    .log-filter {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 999px;
      background: rgba(99,102,241,0.08);
      border: 1px solid rgba(99,102,241,0.18);
      font-size: 0.78rem;
      font-weight: 600;
      color: var(--color-primary-dark);
    }

    .log-filter input {
      accent-color: var(--color-primary);
    }

    .log-clear-btn {
      border-radius: 999px;
      padding: 8px 18px;
      font-size: 0.8rem;
      background: rgba(255,255,255,0.92);
      border: 1px solid rgba(99,102,241,0.22);
      color: var(--color-primary-dark);
      box-shadow: 0 10px 24px -16px rgba(99,102,241,0.6);
    }

    .log-clear-btn i {
      font-size: 0.9rem;
    }

    .log-panel__history {
      border-radius: var(--radius-lg);
      border: 1px solid rgba(15,23,42,0.4);
      background: linear-gradient(160deg, #0f172a 0%, #0b1220 85%);
      padding: 18px;
      max-height: 520px;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: rgba(148,163,184,0.32) transparent;
    }

    .log-panel__history::-webkit-scrollbar {
      width: 6px;
    }

    .log-panel__history::-webkit-scrollbar-thumb {
      background: rgba(148,163,184,0.32);
      border-radius: 999px;
    }

    .log-items {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-family: 'JetBrains Mono', monospace;
    }

    .log-item {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      align-items: flex-start;
      background: linear-gradient(145deg, rgba(30,41,59,0.72), rgba(15,23,42,0.86));
      border: 1px solid rgba(148,163,184,0.12);
      border-radius: 12px;
      padding: 10px 12px;
      color: #e2e8f0;
      box-shadow: 0 8px 18px -14px rgba(15,23,42,0.7);
    }

    .log-item__left {
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    .log-item__team {
      font-weight: 600;
      letter-spacing: 0.04em;
      color: #93c5fd;
    }

    .log-item__message {
      font-size: 0.82rem;
      color: #e2e8f0;
    }

    .log-item__meta {
      font-size: 0.72rem;
      color: #94a3b8;
    }

    .log-item__time {
      font-size: 0.7rem;
      color: #64748b;
      white-space: nowrap;
    }

    .log-item--ack .log-item__team { color: #60a5fa; }
    .log-item--done .log-item__team { color: #5eead4; }
    .log-item--warn .log-item__team { color: #fbbf24; }
    .log-item--dist .log-item__team { color: #f472b6; }
    .log-item--sys .log-item__team { color: #a5b4fc; }

    .log-empty {
      text-align: center;
      padding: 20px 12px;
      color: #94a3b8;
      font-family: 'Inter', system-ui, sans-serif;
      font-size: 0.85rem;
    }


    .log-panel__legend {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      font-size: 0.78rem;
      color: var(--color-muted);
      align-items: center;
    }

    .legend-item {
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .legend-swatch {
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }

    .legend-swatch.team-15 { background: #6366f1; }
    .legend-swatch.team-16 { background: #22d3ee; }
    .legend-swatch.team-18 { background: #f97316; }

    @media (max-width: 1080px) {
      .panel {
        padding: 24px;
      }
    }

    @media (max-width: 720px) {
      .dashboard {
        padding: 28px 16px 48px;
      }

      .log-panel__history {
        max-height: none;
      }

      .command-card__input {
        flex-direction: column;
        align-items: stretch;
      }

      .command-card__input .form-input {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="background-canvas" aria-hidden="true"></div>
  <main class="dashboard">
    <header class="dashboard__header hero glass">
      <div class="hero__content">
        <span class="hero__eyebrow"><i class="bi bi-wifi"></i> Teacher Command Console</span>
        <h1 class="hero__title">Monitor, command, and coach every robot team with clarity.</h1>
        <div class="hero__status">
          <span class="hero__status-dot"></span>
          Connected to HiveMQ Gateway · Syncing heartbeat in the background
        </div>
      </div>
      <div class="hero__metrics">
        <div class="metrics-grid">
          <article class="metric-card">
            <span class="metric-card__label">Robots Online</span>
            <span class="metric-card__value" id="metric-robots-online">0</span>
            <span class="metric-card__sub" id="metric-robots-sub">Waiting for devices</span>
          </article>
          <article class="metric-card">
            <span class="metric-card__label">Critical Alerts</span>
            <span class="metric-card__value" id="metric-alerts">0</span>
            <span class="metric-card__sub" id="metric-alerts-sub">No alerts detected</span>
          </article>
          <article class="metric-card">
            <span class="metric-card__label">Commands Today</span>
            <span class="metric-card__value" id="metric-commands">0</span>
            <span class="metric-card__sub" id="metric-commands-sub">No commands sent yet</span>
          </article>
          <article class="metric-card">
            <span class="metric-card__label">Acknowledgement Rate</span>
            <span class="metric-card__value" id="metric-ack-rate">--</span>
            <span class="metric-card__sub" id="metric-ack-sub">Awaiting first ACK</span>
          </article>
        </div>
      </div>
    </header>

    <section class="connection-panel glass" id="connection-panel">
      <div class="connection-panel__header">
        <h2 class="connection-panel__title">MQTT Connection Setup</h2>
        <p class="connection-panel__subtitle">We preload the classroom HiveMQ credentials so you can connect instantly. Review or edit them before going live.</p>
        <span class="connection-panel__status" id="connection-status-label"><i class="bi bi-plug"></i> Awaiting configuration</span>
      </div>
      <form class="connection-panel__form" id="connection-panel-form" autocomplete="off">
        <div class="form-field full">
          <label class="form-label" for="broker-url-input">Broker URL</label>
          <input class="form-input" id="broker-url-input" name="brokerUrl" type="text" autocomplete="url">
        </div>
        <div class="form-field">
          <label class="form-label" for="root-topic-input">Root Topic</label>
          <input class="form-input" id="root-topic-input" name="rootTopic" type="text" autocomplete="off">
        </div>
        <div class="form-field">
          <label class="form-label" for="mqtt-username-input">MQTT Username</label>
          <input class="form-input" id="mqtt-username-input" name="username" type="text" autocomplete="username">
        </div>
        <div class="form-field">
          <label class="form-label" for="mqtt-password-input">MQTT Password</label>
          <input class="form-input" id="mqtt-password-input" name="password" type="password" autocomplete="current-password">
        </div>
        <div class="form-field">
          <label class="form-label" for="mqtt-clientid-input">Client ID (optional)</label>
          <input class="form-input" id="mqtt-clientid-input" name="clientId" type="text" autocomplete="off">
        </div>
        <div class="form-field">
          <label class="form-label" for="mqtt-keepalive-input">Keep Alive (seconds)</label>
          <input class="form-input" id="mqtt-keepalive-input" name="keepAlive" type="number" min="10" step="5" autocomplete="off">
        </div>
        <div class="form-actions">
          <button class="btn btn--primary" type="button" id="connect-btn"><i class="bi bi-link-45deg"></i> Connect</button>
          <button class="btn btn--ghost" type="button" id="disconnect-btn"><i class="bi bi-power"></i> Disconnect</button>
        </div>
        <div class="connection-panel__footnote">
          <span id="connection-last-saved">Last saved: never</span>
          <button class="btn btn--ghost" type="button" id="clear-connection"><i class="bi bi-trash"></i> Clear Saved Info</button>
        </div>
      </form>
    </section>

    <section class="dashboard__body">
      <aside class="panel teams-panel glass">
        <div class="panel__header">
          <h2 class="panel__title">Teams Directory</h2>
          <p class="panel__subtitle">Select one or more teams to build your watchlist. Live logs and targeted commands respond instantly.</p>
        </div>
        <div class="search-field">
          <i class="bi bi-search"></i>
          <input type="search" placeholder="Search by team name, table, or student...">
        </div>
        <div class="teams-panel__filters">
          <span class="filter-pill is-active">All</span>
          <span class="filter-pill">Active</span>
          <span class="filter-pill">Idle</span>
          <span class="filter-pill">Error</span>
        </div>
        <div class="teams-panel__watchlist">
          <span class="watchlist__title"><i class="bi bi-eye"></i> Watchlist (<span id="watchlist-count">0</span>)</span>
          <div class="watchlist__tags" id="watchlist-tags">
            <span class="watchlist-tag watchlist-tag--empty">No teams selected</span>
          </div>
          <div class="watchlist__meta" id="watchlist-meta">
            <span id="watchlist-meta-text">Select teams below to focus their events here in real-time</span>
            <button type="button" class="watchlist-clear" id="clear-watchlist-btn" disabled>Clear watchlist</button>
          </div>
                <div class="teams-panel__list" id="teams-list">
          <div class="teams-panel__empty" id="teams-empty">No teams detected yet. Robots will appear here once they come online.</div>
        </div>
</div>
        <div class="teams-panel__footer">
          <span>Showing <span id="team-count-label">0</span> teams · scroll for more</span>
        </div>
      </aside>

      <section class="panel command-panel glass">
        <div class="panel__header">
          <h2 class="panel__title">Command Center</h2>
          <p class="panel__subtitle">Send quick broadcast actions or target only the teams you select.</p>
        </div>
        <div class="command-panel__content">
          <div class="command-grid">
            <article class="command-card command-card--broadcast">
              <div class="command-card__header">
                <h3 class="command-card__title">Broadcast Command</h3>
                <p class="command-card__subtitle">Send one instruction to every connected robot.</p>
              </div>
                            <div class="command-card__input">
                <input class="form-input" id="broadcast-command-input" type="text" placeholder='Examples: "STOP", "FWD:1", "LEFT:0.5"'>
                <button class="btn btn--primary" type="button" id="broadcast-submit"><i class="bi bi-broadcast-pin"></i> Broadcast</button>
              </div>
              <div class="command-card__chips command-chips" id="broadcast-presets">
                <button class="command-chip" type="button" data-command="STOP">STOP</button>
                <button class="command-chip" type="button" data-command="FWD:1">FWD:1</button>
                <button class="command-chip" type="button" data-command="LEFT:1">LEFT:1</button>
                <button class="command-chip" type="button" data-command="RIGHT:1">RIGHT:1</button>
                <button class="command-chip" type="button" data-command="BWD:1">BWD:1</button>
              </div>
              
            </article>

            <article class="command-card command-card--targeted">
              <div class="command-card__header">
                <h3 class="command-card__title">Send to Selected Teams</h3>
                <p class="command-card__subtitle">Target only the robots you have checked on the left.</p>
              </div>
              
              <div class="selected-summary" id="selected-summary">
                <span class="selected-summary__title" id="selected-summary-title">No teams selected</span>
                <div class="selected-summary__list" id="selected-summary-list"></div>
                <p class="command-card__subtitle" id="selected-summary-note">Select teams to add them here before sending the command.</p>
              </div>
              <div class="command-card__input">
                <input class="form-input" id="selected-command-input" type="text" placeholder='Example: "RIGHT:0.5"'>
                <button class="btn btn--accent" type="button" id="selected-submit" disabled><i class="bi bi-send-arrow-up"></i> Send to selected (0)</button>
              </div>
              <div class="command-card__meta">
                <span><i class="bi bi-info-circle"></i> Only the robots listed above will receive this command.</span>
              </div>
            </article>
          </div>

          <div id="command-feedback" class="command-feedback is-hidden command-feedback--info">
            <i class="bi bi-info-circle"></i>
            <span id="command-feedback-text">Ready to send commands</span>
          </div>
        </div>
      </section>

      <section class="panel log-panel glass">
        <div class="log-panel__header">
          <div class="log-panel__title">
            <h2 id="log-panel-title">Live Log: All Teams</h2>
            <p>Streaming the last 50 events · Scroll upward for older history.</p>
          </div>
          <div class="log-panel__controls">
            <div class="log-filter-group">
              <label class="log-filter"><input type="checkbox" data-log-filter="ACK" checked> ACK</label>
              <label class="log-filter"><input type="checkbox" data-log-filter="DONE" checked> DONE</label>
              <label class="log-filter"><input type="checkbox" data-log-filter="WARN" checked> WARN</label>
              <label class="log-filter"><input type="checkbox" data-log-filter="DIST" checked> DIST</label>
              <label class="log-filter"><input type="checkbox" data-log-filter="SYS" checked> SYS</label>
            </div>
            <button class="btn btn--ghost log-clear-btn" type="button" id="clear-log-btn"><i class="bi bi-x-circle"></i> Clear Log</button>
          </div>
        </div>
        <div class="log-panel__watchlist">
          <span class="log-panel__watchlist-label" id="log-watchlist-label">Currently showing all teams</span>
          <div class="log-panel__watchlist-tags" id="log-watchlist-tags">
            <span class="watchlist-tag watchlist-tag--empty">All teams</span>
          </div>
        </div>
        <div class="log-panel__history">
          <div class="log-items" id="log-items">
            <div class="log-empty" id="log-empty">Waiting for events...</div>
          </div>
        </div>
        <div class="log-panel__legend">
          <div class="legend-item"><i class="bi bi-info-circle"></i> Filters apply instantly without clearing history</div>
          <div class="legend-item"><i class="bi bi-hdd-network"></i> Listening on subscribed MQTT topics</div>
        </div>
      </section>
    </section>
  </main>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const CONFIG_KEY = 'mqttConfig';
      const sessionConnectKey = 'mqttLastConnect';
      const DEFAULT_CONFIG = {
        brokerUrl: 'wss://a0fa947d537a4c1982d2d44a94275ad2.s1.eu.hivemq.cloud:8884/mqtt',
        rootTopic: 'nlbot',
        username: 'teacher',
        password: 'Stylor123',
        clientId: '',
        keepAlive: '60'
      };

      const inputs = {
        brokerUrl: document.getElementById('broker-url-input'),
        rootTopic: document.getElementById('root-topic-input'),
        username: document.getElementById('mqtt-username-input'),
        password: document.getElementById('mqtt-password-input'),
        clientId: document.getElementById('mqtt-clientid-input'),
        keepAlive: document.getElementById('mqtt-keepalive-input')
      };

      const connectBtn = document.getElementById('connect-btn');
      const disconnectBtn = document.getElementById('disconnect-btn');
      const clearBtn = document.getElementById('clear-connection');
      const statusLabel = document.getElementById('connection-status-label');
      const lastSavedLabel = document.getElementById('connection-last-saved');

      if (!statusLabel) { return; }

      function formatTimestamp(value) {
        if (!value) { return null; }
        const parsed = new Date(value);
        if (Number.isNaN(parsed.getTime())) { return null; }
        return parsed.toLocaleString(undefined, { dateStyle: 'medium', timeStyle: 'short' });
      }

      function setStatus(state, message) {
        statusLabel.classList.remove('is-ready', 'is-stale', 'is-empty');
        const templates = {
          ready: `<i class="bi bi-unlock"></i> ${message || 'Credentials ready'}`,
          stale: `<i class="bi bi-hourglass-split"></i> ${message || 'Verify credentials'}`,
          empty: `<i class="bi bi-plug"></i> ${message || 'Awaiting configuration'}`
        };
        const className = state === 'ready' ? 'is-ready' : state === 'stale' ? 'is-stale' : 'is-empty';
        statusLabel.classList.add(className);
        statusLabel.innerHTML = templates[state] || templates.empty;
      }

      function loadStoredConfig() {
        const raw = localStorage.getItem(CONFIG_KEY);
        if (!raw) { return null; }
        try {
          return JSON.parse(raw);
        } catch {
          return null;
        }
      }

      function applyConfig(config) {
        const active = { ...DEFAULT_CONFIG, ...(config || {}) };
        Object.entries(inputs).forEach(([key, input]) => {
          if (!input) { return; }
          input.value = active[key] ?? '';
        });

        const savedAt = config?.savedAt ? formatTimestamp(config.savedAt) : null;
        if (savedAt) {
          lastSavedLabel.textContent = `Last saved: ${savedAt}`;
        } else {
          lastSavedLabel.textContent = 'Last saved: not saved yet';
        }

        if (!config) {
          setStatus('empty', 'Awaiting configuration');
          if (clearBtn) { clearBtn.disabled = true; }
        } else {
          const savedTime = config.savedAt ? new Date(config.savedAt).getTime() : null;
          const isStale = savedTime ? (Date.now() - savedTime) > (1000 * 60 * 60 * 12) : false;
          setStatus(isStale ? 'stale' : 'ready', isStale ? 'Verify credentials' : 'Credentials ready');
          if (clearBtn) { clearBtn.disabled = false; }
        }
      }

      function gatherConfig() {
        return {
          brokerUrl: inputs.brokerUrl?.value.trim() ?? '',
          rootTopic: inputs.rootTopic?.value.trim() ?? '',
          username: inputs.username?.value.trim() ?? '',
          password: inputs.password?.value ?? '',
          clientId: inputs.clientId?.value.trim() ?? '',
          keepAlive: inputs.keepAlive?.value.trim() ?? '',
          savedAt: new Date().toISOString()
        };
      }

      function persistConfig() {
        const payload = gatherConfig();
        localStorage.setItem(CONFIG_KEY, JSON.stringify(payload));
        applyConfig(payload);
        return payload;
      }

      function handleConnectClick() {
        const saved = persistConfig();
        sessionStorage.setItem(sessionConnectKey, saved.savedAt);
        document.dispatchEvent(new CustomEvent('mqtt:config-saved', { detail: saved }));
        document.dispatchEvent(new CustomEvent('mqtt:connect-requested', { detail: saved }));
      }

      function handleDisconnectClick() {
        setStatus('empty', 'Disconnected from broker');
        stopMqttClient();
        const saved = loadStoredConfig();
        if (saved) {
          lastSavedLabel.textContent = saved.savedAt ? `Last saved: ${formatTimestamp(saved.savedAt)}` : 'Last saved: not saved yet';
        }
      }

      function handleClearClick() {
        if (clearBtn?.disabled) { return; }
        const confirmed = confirm('Remove the saved MQTT credentials from this device?');
        if (!confirmed) { return; }
        localStorage.removeItem(CONFIG_KEY);
        sessionStorage.removeItem(sessionConnectKey);
        applyConfig(null);
        document.dispatchEvent(new Event('mqtt:config-cleared'));
      }

      const storedConfig = loadStoredConfig();
      applyConfig(storedConfig);

      if (connectBtn) {
        connectBtn.addEventListener('click', () => {
          handleConnectClick();
        });
      }

      if (disconnectBtn) {
        disconnectBtn.addEventListener('click', () => {
          handleDisconnectClick();
        });
      }

      if (clearBtn) {
        clearBtn.addEventListener('click', () => {
          handleClearClick();
        });
      }

      // --- Command Center Interactions ---
      const commandFeedback = document.getElementById('command-feedback');
      const commandFeedbackText = document.getElementById('command-feedback-text');
      const broadcastInput = document.getElementById('broadcast-command-input');
      const broadcastBtn = document.getElementById('broadcast-submit');
      const selectedInput = document.getElementById('selected-command-input');
      const selectedBtn = document.getElementById('selected-submit');
      const presetButtons = document.querySelectorAll('#broadcast-presets .command-chip');
      const broadcastOnlineCount = document.getElementById('broadcast-online-count');
      const watchlistCount = document.getElementById('watchlist-count');
      const watchlistTags = document.getElementById('watchlist-tags');
      const watchlistMetaText = document.getElementById('watchlist-meta-text');
      const clearWatchlistBtn = document.getElementById('clear-watchlist-btn');
      const selectedSummaryTitle = document.getElementById('selected-summary-title');
      const selectedSummaryList = document.getElementById('selected-summary-list');
      const selectedSummaryNote = document.getElementById('selected-summary-note');
      const teamCountLabel = document.getElementById('team-count-label');
      const logContainer = document.getElementById('log-items');
      const logFilterInputs = document.querySelectorAll('[data-log-filter]');
      const clearLogButton = document.getElementById('clear-log-btn');
      const logWatchlistLabel = document.getElementById('log-watchlist-label');
      const logWatchlistTags = document.getElementById('log-watchlist-tags');
      const logTitle = document.getElementById('log-panel-title');
      const teamListEl = document.getElementById('teams-list');
      let teamEmptyEl = document.getElementById('teams-empty');
      let teamCardMap = {};
      let mqttClientInstance = null;
      let mqttCurrentConfig = null;
      let logEntries = [];
      const LOG_MAX_ITEMS = 200;

      function normalizeTeamKey(raw) {
        if (!raw) { return ''; }
        return raw.toUpperCase().replace(/[^A-Z0-9]/g, '');
      }

      function sanitizeTopicPath(value) {
        if (!value) { return ''; }
        let result = String(value).trim();
        if (!result) { return ''; }
        result = result.replace(/^[\s/]+/, '').replace(/\s+/g, '').replace(/\/+/g, '/');
        result = result.replace(/\/$/, '');
        while (/\/(cmd|evt)$/i.test(result)) {
          result = result.replace(/\/(cmd|evt)$/i, '');
        }
        const wildcardIndex = result.search(/[#+]/);
        if (wildcardIndex !== -1) {
          result = result.slice(0, wildcardIndex);
          result = result.replace(/\/$/, '');
        }
        return result;
      }

      function topicWithCommandSuffix(base) {
        const clean = sanitizeTopicPath(base);
        return clean ? `${clean}/cmd` : '';
      }

      function toTopicSegment(value) {
        if (!value) { return ''; }
        return String(value).trim().replace(/[^A-Za-z0-9_-]/g, '').toUpperCase();
      }

      const accentPalette = ['#6366f1', '#22d3ee', '#f97316', '#10b981', '#ec4899', '#38bdf8', '#a855f7', '#facc15'];
      let accentIndex = 0;

      function getAccentColor() {
        const color = accentPalette[accentIndex % accentPalette.length];
        accentIndex += 1;
        return color;
      }

      function registerTeamCard(card) {
        if (!card) { return; }
        const teamId = (card.dataset.team || '').toUpperCase();
        const simpleId = normalizeTeamKey(teamId);
        if (teamId) { teamCardMap[teamId] = card; }
        if (simpleId) { teamCardMap[simpleId] = card; }
        const sanitizedBase = sanitizeTopicPath(card.dataset.topicBase || '');
        if (sanitizedBase !== (card.dataset.topicBase || '')) {
          card.dataset.topicBase = sanitizedBase;
        }
        const topicBaseKey = sanitizedBase.toUpperCase();
        if (topicBaseKey) { teamCardMap[topicBaseKey] = card; }
        const checkbox = card.querySelector('input[type="checkbox"]');
        if (!card.dataset.registered && checkbox) {
          checkbox.addEventListener('change', () => updateWatchlist());
          card.dataset.registered = '1';
        }
      }

      function ensureTeamsPlaceholder() {
        if (!teamListEl) { return; }
        if (teamListEl.querySelector('.team-card')) { return; }
        if (!teamListEl.querySelector('.teams-panel__empty')) {
          const placeholder = document.createElement('div');
          placeholder.className = 'teams-panel__empty';
          placeholder.id = 'teams-empty';
          placeholder.textContent = 'No teams detected yet. Robots will appear here once they come online.';
          teamListEl.appendChild(placeholder);
          teamEmptyEl = placeholder;
        }
      }

      function createTeamCard(teamId, topicBase) {
        if (!teamListEl) { return null; }
        const normalized = normalizeTeamKey(teamId);
        const existing = findTeamCardByTopicId(teamId);
        if (existing) {
          if (topicBase) { existing.dataset.topicBase = sanitizeTopicPath(topicBase); registerTeamCard(existing); }
          return existing;
        }
        const accent = getAccentColor();
        const sanitizedRoot = sanitizeTopicPath(mqttCurrentRootTopic);
        const sanitizedTopicBase = sanitizeTopicPath(topicBase);
        const fallbackSegment = toTopicSegment(teamId);
        const resolvedBase = sanitizedTopicBase || (sanitizedRoot && fallbackSegment ? `${sanitizedRoot}/${fallbackSegment}` : '');
        const card = document.createElement('label');
        card.className = 'team-card status-active';
        card.dataset.team = teamId;
        card.style.setProperty('--accent', accent);
        card.dataset.defaultStateLabel = 'Online';
        card.dataset.defaultStateClass = 'team-card__state team-card__state--online';
        card.dataset.topicBase = resolvedBase;
        card.innerHTML = `
            <input type="checkbox">
            <div class="team-card__content">
              <div class="team-card__row">
                <div class="team-card__identity">
                  <span class="team-card__status-dot"></span>
                  ${escapeHtml(teamId)}
                </div>
                <span class="team-card__state team-card__state--online" data-role="state-label">Online</span>
              </div>
            </div>
        `;
        if (teamEmptyEl) {
          teamEmptyEl.remove();
          teamEmptyEl = null;
        }
        teamListEl.appendChild(card);
        registerTeamCard(card);
        updateTeamCount();
        updateOnlineCount();
        return card;
      }

      function findTeamCardByTopicId(topicId) {
        if (!topicId) { return null; }
        const variants = [];
        const upper = topicId.toUpperCase();
        variants.push(upper);
        variants.push(normalizeTeamKey(upper));
        if (upper.includes('-')) {
          variants.push(upper.replace(/-/g, ''));
        }
        const trailingDigits = upper.match(/(\d{1,4})$/);
        if (trailingDigits && trailingDigits[1]) {
          const rawSuffix = trailingDigits[1];
          const suffixNoLeadingZero = rawSuffix.replace(/^0+/, '') || rawSuffix;
          variants.push(`TEAM-${suffixNoLeadingZero}`);
          variants.push(`TEAM${suffixNoLeadingZero}`);
          if (rawSuffix !== suffixNoLeadingZero) {
            variants.push(`TEAM-${rawSuffix}`);
            variants.push(`TEAM${rawSuffix}`);
          }
        }
        for (const key of variants) {
          if (key && teamCardMap[key]) { return teamCardMap[key]; }
        }
        return null;
      }

      function accentToRgba(hex, alpha) {
        if (!hex) { return `rgba(99,102,241,${alpha})`; }
        const shorthandRegex = /^#?([a-f\d])([a-f\d])([a-f\d])$/i;
        const fullHex = hex.replace(shorthandRegex, (m, r, g, b) => r + r + g + g + b + b);
        const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(fullHex);
        if (!result) { return `rgba(99,102,241,${alpha})`; }
        const r = parseInt(result[1], 16);
        const g = parseInt(result[2], 16);
        const b = parseInt(result[3], 16);
        return `rgba(${r}, ${g}, ${b}, ${alpha})`;
      }

      function escapeHtml(value) {
        if (value == null) { return ''; }
        return String(value).replace(/[&<>"']/g, ch => ({
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#39;',
        }[ch] || ch));
      }

      function buildTeamDescriptor(card) {
        const identity = card.querySelector('.team-card__identity');
        const fullText = identity ? identity.textContent.trim() : '';
        const [rawId, rawName] = fullText.split('·').map(part => part?.trim());
        const teamId = card.dataset.team || rawId || 'TEAM';
        const name = card.dataset.name || rawName || '';
        const label = name ? `${teamId} (${name})` : teamId;
        const accent = card.style.getPropertyValue('--accent') || '#6366f1';
        const topicBase = card.dataset.topicBase || '';
        return { teamId, name, label, accent, topicBase };
      }

      function getAllTeamCards() {
        return teamListEl ? Array.from(teamListEl.querySelectorAll('.team-card')) : [];
      }
      const metricElements = {
        robotsValue: document.getElementById('metric-robots-online'),
        robotsSub: document.getElementById('metric-robots-sub'),
        alertsValue: document.getElementById('metric-alerts'),
        alertsSub: document.getElementById('metric-alerts-sub'),
        commandsValue: document.getElementById('metric-commands'),
        commandsSub: document.getElementById('metric-commands-sub'),
        ackValue: document.getElementById('metric-ack-rate'),
        ackSub: document.getElementById('metric-ack-sub'),
      };

      const metricState = {
        commandsBroadcast: 0,
        commandsTargeted: 0,
        ackEvents: 0,
        warnEvents: 0,
      };

      function refreshMetrics(overrides = {}) {
        const cards = getAllTeamCards();
        const totalTeams = typeof overrides.total === 'number' ? overrides.total : cards.length;
        let onlineTeams = overrides.online;
        if (typeof onlineTeams !== 'number') {
          onlineTeams = cards.filter(card => !card.classList.contains('status-offline')).length;
        }
        const alertTeams = cards.filter(card => card.classList.contains('status-error')).length;
        const totalCommands = metricState.commandsBroadcast + metricState.commandsTargeted;
        const commandLabel = Number.isFinite(totalCommands) ? totalCommands : 0;

        if (metricElements.robotsValue) {
          const onlineLabel = Number.isFinite(onlineTeams) ? onlineTeams : 0;
          metricElements.robotsValue.textContent = onlineLabel.toString();
          if (metricElements.robotsSub) {
            const offlineTeams = Math.max(totalTeams - onlineLabel, 0);
            metricElements.robotsSub.textContent = totalTeams
              ? `${offlineTeams} offline · ${totalTeams} total`
              : 'Waiting for devices';
          }
        }

        if (metricElements.alertsValue) {
          const alertLabel = Number.isFinite(alertTeams) ? alertTeams : 0;
          metricElements.alertsValue.textContent = alertLabel.toString();
          if (metricElements.alertsSub) {
            metricElements.alertsSub.textContent = alertLabel
              ? `${alertLabel} active issue${alertLabel === 1 ? '' : 's'}`
              : 'No alerts detected';
          }
        }

        if (metricElements.commandsValue) {
          metricElements.commandsValue.textContent = commandLabel.toString();
          if (metricElements.commandsSub) {
            metricElements.commandsSub.textContent = commandLabel
              ? `${metricState.commandsTargeted} targeted · ${metricState.commandsBroadcast} broadcast`
              : 'No commands sent yet';
          }
        }

        if (metricElements.ackValue) {
          if (!commandLabel) {
            metricElements.ackValue.textContent = '--';
            if (metricElements.ackSub) {
              metricElements.ackSub.textContent = 'Awaiting first ACK';
            }
          } else {
            const ackRate = Math.min(100, Math.round((metricState.ackEvents / commandLabel) * 100));
            metricElements.ackValue.textContent = `${ackRate}%`;
            if (metricElements.ackSub) {
              metricElements.ackSub.textContent = `ACK events ${metricState.ackEvents} · WARN ${metricState.warnEvents}`;
            }
          }
        }
      }

      function resetMetricState() {
        metricState.commandsBroadcast = 0;
        metricState.commandsTargeted = 0;
        metricState.ackEvents = 0;
        metricState.warnEvents = 0;
        refreshMetrics({ online: 0, total: 0 });
      }

      resetMetricState();

      function getSelectedCards() {
        if (!teamListEl) { return []; }
        return Array.from(teamListEl.querySelectorAll('.team-card input[type="checkbox"]:checked')).map(cb => cb.closest('.team-card'));
      }

      function showCommandFeedback(message, tone = 'info') {
        if (!commandFeedback || !commandFeedbackText) { return; }
        commandFeedback.classList.remove('is-hidden', 'command-feedback--info', 'command-feedback--success', 'command-feedback--warn');
        const toneClass = tone === 'success'
          ? 'command-feedback--success'
          : tone === 'warn'
            ? 'command-feedback--warn'
            : 'command-feedback--info';
        commandFeedback.classList.add(toneClass);
        const icon = commandFeedback.querySelector('i');
        if (icon) {
          icon.className = tone === 'success'
            ? 'bi bi-check-circle'
            : tone === 'warn'
              ? 'bi bi-exclamation-triangle'
              : 'bi bi-info-circle';
        }
        commandFeedbackText.textContent = message;
      }

      function updateTargetButton(count) {
        if (!selectedBtn) { return; }
        const safeCount = typeof count === 'number' ? count : getSelectedCards().length;
        selectedBtn.disabled = safeCount === 0;
        selectedBtn.innerHTML = `<i class="bi bi-send-arrow-up"></i> Send to selected (${safeCount})`;
      }

      function updateWatchlist() {
        if (!watchlistCount || !watchlistTags || !watchlistMetaText || !selectedSummaryTitle || !selectedSummaryList || !selectedSummaryNote) {
          return;
        }

        const selected = getSelectedCards().map(buildTeamDescriptor);
        watchlistCount.textContent = selected.length;
        watchlistTags.innerHTML = '';
        selectedSummaryList.innerHTML = '';
        if (logWatchlistTags) {
          logWatchlistTags.innerHTML = '';
        }
        if (clearWatchlistBtn) {
          clearWatchlistBtn.disabled = selected.length === 0;
        }

        if (!selected.length) {
          const placeholderTag = document.createElement('span');
          placeholderTag.className = 'watchlist-tag watchlist-tag--empty';
          placeholderTag.textContent = 'No teams selected';
          watchlistTags.appendChild(placeholderTag);
          watchlistMetaText.textContent = 'Select teams below to focus their events here in real-time';
          selectedSummaryTitle.textContent = 'No teams selected';
          selectedSummaryNote.textContent = 'Select teams to add them here before sending the command.';
          if (logWatchlistTags) {
            const logTag = document.createElement('span');
            logTag.className = 'watchlist-tag watchlist-tag--empty';
            logTag.textContent = 'All teams';
            logWatchlistTags.appendChild(logTag);
          }
          if (logWatchlistLabel) {
            logWatchlistLabel.textContent = 'Currently showing all teams';
          }
          if (logTitle) {
            logTitle.textContent = 'Live Log: All Teams';
          }
        } else {
          selected.forEach(info => {
            const tag = document.createElement('span');
            tag.className = 'watchlist-tag';
            tag.textContent = info.teamId;
            tag.style.setProperty('--tag-color', info.accent);
            tag.style.setProperty('--tag-bg', accentToRgba(info.accent, 0.16));
            tag.style.setProperty('--tag-border', accentToRgba(info.accent, 0.32));
            watchlistTags.appendChild(tag);

            const item = document.createElement('span');
            item.className = 'selected-summary__item';
            item.textContent = info.label;
            selectedSummaryList.appendChild(item);

            if (logWatchlistTags) {
              const logTag = document.createElement('span');
              logTag.className = 'watchlist-tag';
              logTag.textContent = info.teamId;
              logTag.style.setProperty('--tag-color', info.accent);
              logTag.style.setProperty('--tag-bg', accentToRgba(info.accent, 0.16));
              logTag.style.setProperty('--tag-border', accentToRgba(info.accent, 0.32));
              logWatchlistTags.appendChild(logTag);
            }
          });

          watchlistMetaText.textContent = `Monitoring ${selected.length} team(s) — use the command panel for targeted actions.`;
          selectedSummaryTitle.textContent = `Selected teams (${selected.length})`;
          selectedSummaryNote.textContent = 'Only the teams listed here will receive the targeted command.';
          if (logWatchlistLabel) {
            logWatchlistLabel.textContent = `Filtering ${selected.length} team(s)`;
          }
          if (logTitle) {
            const teamList = selected.map(info => info.teamId).join(', ');
            logTitle.textContent = `Live Log: ${teamList}`;
          }
        }

        updateTargetButton(selected.length);
      }

      function updateOnlineCount() {
        const onlineTeams = getAllTeamCards().filter(card => !card.classList.contains('status-offline')).length;
        if (broadcastOnlineCount) {
          broadcastOnlineCount.textContent = onlineTeams;
        }
        refreshMetrics({ online: onlineTeams });
      }

      function updateTeamCount() {
        const totalTeams = getAllTeamCards().length;
        if (teamCountLabel) {
          teamCountLabel.textContent = totalTeams.toString();
        }
        refreshMetrics({ total: totalTeams });
      }

      function formatTimeLabel(date) {
        if (!date) { return ''; }
        return new Intl.DateTimeFormat('th-TH', {
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit'
        }).format(date);
      }

      function updateTeamCardStatus(card, event, timestamp) {
        if (!card || !event) { return; }
        card.classList.remove('status-error', 'status-offline', 'status-idle');
        const stateLabel = card.querySelector('[data-role="state-label"]');
        if (stateLabel) {
          const defaultText = card.dataset.defaultStateLabel || 'Online';
          const defaultClass = card.dataset.defaultStateClass || 'team-card__state team-card__state--online';
          let nextText = defaultText;
          let nextClass = defaultClass;
          if (event.type === 'WARN') {
            nextText = 'Issue';
            nextClass = 'team-card__state team-card__state--issue';
            card.classList.add('status-error');
          } else if (event.type === 'SYS') {
            const msg = (event.message || '').toLowerCase();
            if (msg.includes('disconnect')) {
              nextText = 'Disconnected';
              nextClass = 'team-card__state team-card__state--offline';
              card.classList.add('status-offline');
            } else if (msg.includes('connecting')) {
              nextText = 'Connecting';
              nextClass = 'team-card__state team-card__state--waiting';
              card.classList.add('status-idle');
            } else if (msg.includes('connected')) {
              nextText = 'Online';
              nextClass = 'team-card__state team-card__state--online';
              card.classList.add('status-active');
            }
          } else {
            nextText = event.type === 'ACK' || event.type === 'DONE' ? 'Online' : defaultText;
            nextClass = 'team-card__state team-card__state--online';
            card.classList.add('status-active');
          }
          stateLabel.className = nextClass;
          stateLabel.textContent = nextText;
        }
        card.dataset.lastEventAt = timestamp ? timestamp.toISOString() : '';
      }

      function getActiveLogFilters() {
        const defaults = ['ACK', 'DONE', 'WARN', 'DIST', 'SYS'];
        if (!logFilterInputs || !logFilterInputs.length) {
          return new Set(defaults);
        }
        const active = new Set();
        logFilterInputs.forEach(input => {
          if (input.checked) {
            active.add(input.dataset.logFilter);
          }
        });
        if (!active.size) {
          defaults.forEach(t => active.add(t));
        }
        return active;
      }

      function publishMqttCommand(topic, command) {
        if (!mqttClientInstance || !mqttClientInstance.connected) {
          showCommandFeedback('MQTT is not connected', 'warn');
          return false;
        }
        try {
          mqttClientInstance.publish(topic, `${command}\n`, { qos: 1 });
          return true;
        } catch (error) {
          console.error('[MQTT] publish error', error);
          showCommandFeedback(`Failed to publish to ${topic}: ${error.message || error}`, 'warn');
          return false;
        }
      }

      function renderLogEntries() {
        if (!logContainer) { return; }
        logContainer.innerHTML = '';
        const activeFilters = getActiveLogFilters();
        const visibleEntries = logEntries.filter(entry => activeFilters.has(entry.type));
        if (!visibleEntries.length) {
          const empty = document.createElement('div');
          empty.className = 'log-empty';
          empty.textContent = logEntries.length
            ? 'No log entries match the selected filters.'
            : 'Waiting for events...';
          logContainer.appendChild(empty);
          return;
        }

        visibleEntries.forEach(entry => {
          const item = document.createElement('div');
          item.className = `log-item log-item--${entry.type.toLowerCase()}`;
          const messageText = entry.message || entry.description || '';
          item.innerHTML = `
            <div class="log-item__left">
              <span class="log-item__team">[${escapeHtml(entry.teamLabel)}]</span>
              <span class="log-item__message">${escapeHtml(messageText)}</span>
              ${entry.meta ? `<span class="log-item__meta">${escapeHtml(entry.meta)}</span>` : ''}
            </div>
            <span class="log-item__time">${escapeHtml(entry.timeLabel)}</span>
          `;
          const teamEl = item.querySelector('.log-item__team');
          if (teamEl && entry.accent) {
            teamEl.style.color = entry.accent;
          }
          logContainer.appendChild(item);
        });
      }

      function addLogEntry(entry) {
        if (!entry) { return; }
        entry.type = (entry.type || '').toUpperCase();
        if (!entry.timeLabel && entry.time instanceof Date) {
          entry.timeLabel = formatTimeLabel(entry.time);
        }
        entry.meta = '';
        logEntries.unshift(entry);
        if (logEntries.length > LOG_MAX_ITEMS) {
          logEntries = logEntries.slice(0, LOG_MAX_ITEMS);
        }
        renderLogEntries();
      }

      function parseRobotEvent(payload) {
        if (!payload) { return null; }
        const trimmed = payload.trim();
        if (!trimmed) { return null; }
        const [head, ...rest] = trimmed.split(' ');
        const type = (head || '').toUpperCase();
        const message = rest.join(' ').trim();
        return {
          type,
          raw: trimmed,
          message,
          command: ['ACK', 'DONE'].indexOf(type) >= 0 ? message : '',
        };
      }

      function handleMqttMessage(topic, payload) {
        const parts = topic.split('/').filter(Boolean);
        if (parts.length < 2) { return; }
        const evtSegment = parts[parts.length - 1].toLowerCase();
        if (evtSegment !== 'evt') { return; }
        const teamKey = parts[parts.length - 2];
        const event = parseRobotEvent(payload);
        if (!event) { return; }
        const timestamp = new Date();
        const topicBase = parts.slice(0, -1).join('/');
        let card = findTeamCardByTopicId(teamKey) || findTeamCardByTopicId(topicBase);
        if (!card) {
          card = createTeamCard(teamKey, topicBase);
        } else {
          card.dataset.topicBase = sanitizeTopicPath(topicBase);
          registerTeamCard(card);
        }
        if (card && ['ACK', 'DONE', 'WARN', 'DIST'].indexOf(event.type) >= 0) {
          updateTeamCardStatus(card, event, timestamp);
        }
        const identity = card ? (card.querySelector('.team-card__identity')?.textContent.trim() || teamKey) : teamKey;
        const accent = card?.style?.getPropertyValue('--accent') || (event.type === 'SYS' ? '#818cf8' : '#6366f1');
        const timeLabel = formatTimeLabel(timestamp);
        const rawLine = event.raw || `${event.type}${event.message ? ' ' + event.message : ''}`;
        addLogEntry({
          teamKey,
          teamLabel: identity || teamKey,
          type: event.type,
          message: rawLine,
          meta: '',
          raw: event.raw,
          time: timestamp,
          timeLabel,
          accent,
        });
        if (event.type === 'WARN') {
          metricState.warnEvents += 1;
        } else if (event.type === 'ACK') {
          metricState.ackEvents += 1;
        }
        refreshMetrics();
      }

      function startMqttClient(config) {
        if (typeof mqtt === 'undefined') {
          showCommandFeedback('MQTT library is not available on this page', 'warn');
          return;
        }
        stopMqttClient();
        if (!config || !config.brokerUrl) {
          showCommandFeedback('Please provide a Broker URL before connecting', 'warn');
          return;
        }

        mqttCurrentConfig = config;
        const sanitizedRoot = sanitizeTopicPath(config.rootTopic || '');
        mqttCurrentRootTopic = sanitizedRoot;
        const options = {
          reconnectPeriod: 1500,
          clean: true,
        };
        if (config.username) {
          options.username = config.username;
          options.password = config.password || '';
        }
        if (config.clientId) {
          options.clientId = config.clientId;
        }
        const keepAlive = parseInt(config.keepAlive, 10);
        if (!Number.isNaN(keepAlive) && keepAlive > 0) {
          options.keepalive = keepAlive;
        }

        try {
          mqttClientInstance = mqtt.connect(config.brokerUrl, options);
        } catch (error) {
          console.error('[MQTT] connect error', error);
          showCommandFeedback(`Failed to connect to MQTT: ${error.message || error}`, 'warn');
          mqttClientInstance = null;
          return;
        }

        const baseTopic = sanitizedRoot;

        mqttClientInstance.on('connect', () => {
          showCommandFeedback('MQTT connected, listening for events...', 'success');
          if (baseTopic) {
            const subscribeTopic = `${baseTopic}/#`;
            mqttClientInstance.subscribe(subscribeTopic, err => {
              if (err) {
                showCommandFeedback(`Subscribe failed: ${err.message || err}`, 'warn');
              } else {
                showCommandFeedback(`Subscribed to ${subscribeTopic}`, 'info');
              }
            });
          } else {
            showCommandFeedback('Please set a root topic to subscribe', 'warn');
          }
        });

        mqttClientInstance.on('message', (topic, payloadBuffer) => {
          const payload = payloadBuffer.toString();
          handleMqttMessage(topic, payload);
        });

        mqttClientInstance.on('error', err => {
          console.error('[MQTT] error', err);
          showCommandFeedback(`MQTT error: ${err.message || err}`, 'warn');
        });

        mqttClientInstance.on('close', () => {
          showCommandFeedback('Disconnected from MQTT', 'info');
        });
      }

      function stopMqttClient() {
        if (mqttClientInstance) {
          try {
            mqttClientInstance.end(true);
          } catch (e) {
            console.warn('MQTT disconnect error', e);
          }
          mqttClientInstance = null;
        }
        mqttCurrentRootTopic = '';
      }

      function handleBroadcastSubmit() {
        if (!broadcastInput) { return; }
        const command = broadcastInput.value.trim().toUpperCase();
        if (!command) {
          showCommandFeedback('Please enter a command before broadcasting', 'warn');
          broadcastInput.focus();
          return;
        }
        const recipients = getAllTeamCards()
          .filter(card => !card.classList.contains('status-offline'))
          .map(buildTeamDescriptor);
        const sanitizedRoot = sanitizeTopicPath(mqttCurrentRootTopic);
        const normalizedRoot = (sanitizedRoot || '').toUpperCase();
        const topics = new Set();
        const parentTopics = new Set();
        const resolvedRecipients = [];

        const rootCommandTopic = topicWithCommandSuffix(sanitizedRoot);
        if (rootCommandTopic) { topics.add(rootCommandTopic); }

        recipients.forEach(info => {
          const resolved = { ...info };
          let base = sanitizeTopicPath(info.topicBase);
          if (!base && sanitizedRoot) {
            const fallbackSegment = toTopicSegment(info.teamId);
            if (fallbackSegment) {
              base = `${sanitizedRoot}/${fallbackSegment}`;
            }
          }
          resolved.topicBase = base;
          resolvedRecipients.push(resolved);
          if (!base) { return; }

          const parent = base.includes('/') ? base.slice(0, base.lastIndexOf('/')) : '';
          if (parent) {
            const parentTopic = topicWithCommandSuffix(parent);
            if (parentTopic && parent.toUpperCase() !== normalizedRoot) {
              parentTopics.add(parentTopic);
            }
          } else {
            const baseTopic = topicWithCommandSuffix(base);
            if (baseTopic) { parentTopics.add(baseTopic); }
          }
        });

        parentTopics.forEach(topic => { if (topic) { topics.add(topic); } });

        const topicList = Array.from(topics).filter(Boolean);
        if (topicList.length) {
          console.debug('[Admin] Broadcast topics', topicList);
        } else {
          console.warn('[Admin] Broadcast has no resolved MQTT topics', { sanitizedRoot, recipients: resolvedRecipients });
        }
        if (!topicList.length) {
          showCommandFeedback('No MQTT topics available for broadcast. Check your root topic.', 'warn');
          return;
        }
        let publishCount = 0;
        topicList.forEach(topic => {
          if (publishMqttCommand(topic, command)) { publishCount += 1; }
        });
        if (!publishCount) {
          showCommandFeedback('Failed to publish broadcast command. Verify MQTT connectivity.', 'warn');
          return;
        }
        const topicSummary = topicList.join(', ');
        showCommandFeedback(`Sent "${command}" via ${publishCount} topic${publishCount === 1 ? '' : 's'}: ${topicSummary}`, 'success');
        broadcastInput.value = '';
        const detail = { command, teams: resolvedRecipients, topics: topicList, published: publishCount };
        document.dispatchEvent(new CustomEvent('admin:broadcast-command', { detail }));
      }

      function handleSelectedSubmit() {
        if (!selectedInput) { return; }
        const selectedTeams = getSelectedCards().map(buildTeamDescriptor);
        if (!selectedTeams.length) {
          showCommandFeedback('No teams selected for this command', 'warn');
          return;
        }

        const command = selectedInput.value.trim().toUpperCase();
        if (!command) {
          showCommandFeedback('Please enter a command for the selected teams', 'warn');
          selectedInput.focus();
          return;
        }

        const sanitizedRoot = sanitizeTopicPath(mqttCurrentRootTopic);
        const topics = new Set();
        selectedTeams.forEach(team => {
          let base = sanitizeTopicPath(team.topicBase);
          if (!base && sanitizedRoot) {
            const fallbackSegment = toTopicSegment(team.teamId);
            if (fallbackSegment) {
              base = `${sanitizedRoot}/${fallbackSegment}`;
            }
          }
          const commandTopic = topicWithCommandSuffix(base);
          if (commandTopic) {
            topics.add(commandTopic);
          }
        });

        const topicList = Array.from(topics).filter(Boolean);
        if (topicList.length) {
          console.debug('[Admin] Targeted topics', topicList, selectedTeams);
        } else {
          console.warn('[Admin] Targeted send missing topics', selectedTeams);
        }

        if (!topicList.length) {
          showCommandFeedback('Could not resolve MQTT topic for the selected teams. Check their topic configuration.', 'warn');
          return;
        }

        let publishCount = 0;
        topicList.forEach(topic => {
          if (publishMqttCommand(topic, command)) { publishCount += 1; }
        });

        if (!publishCount) {
          showCommandFeedback('Failed to publish command to the selected teams. Verify MQTT connectivity.', 'warn');
          return;
        }

        selectedInput.value = '';
        const teamList = selectedTeams.map(team => team.teamId).join(', ');
        const detail = { command, teams: selectedTeams, topics: topicList, published: publishCount };
        const topicSummary = topicList.join(', ');
        showCommandFeedback(`Sent "${command}" to ${teamList} via ${publishCount} topic${publishCount === 1 ? '' : 's'}: ${topicSummary}`, 'success');
        document.dispatchEvent(new CustomEvent('admin:selected-command', { detail }));
      }

      if (broadcastBtn) {
        broadcastBtn.addEventListener('click', handleBroadcastSubmit);
      }

      if (selectedBtn) {
        selectedBtn.addEventListener('click', handleSelectedSubmit);
      }

      if (broadcastInput) {
        broadcastInput.addEventListener('keydown', event => {
          if (event.key === 'Enter') {
            event.preventDefault();
            handleBroadcastSubmit();
          }
        });
      }

      if (selectedInput) {
        selectedInput.addEventListener('keydown', event => {
          if (event.key === 'Enter') {
            event.preventDefault();
            handleSelectedSubmit();
          }
        });
      }

      if (presetButtons.length) {
        presetButtons.forEach(button => {
          button.addEventListener('click', () => {
            const command = (button.dataset.command || button.textContent || '').trim();
            if (!command || !broadcastInput) { return; }
            broadcastInput.value = command;
            broadcastInput.focus();
            showCommandFeedback(`Prefilled command "${command}"`, 'info');
          });
        });
      }

      if (clearWatchlistBtn) {
        clearWatchlistBtn.addEventListener('click', () => {
          getAllTeamCards().forEach(card => {
            const checkbox = card.querySelector('input[type="checkbox"]');
            if (checkbox) {
              checkbox.checked = false;
            }
          });
          updateWatchlist();
          showCommandFeedback('Cleared watchlist', 'info');
        });
      }

      if (logFilterInputs && logFilterInputs.length) {
        logFilterInputs.forEach(input => {
          input.addEventListener('change', () => renderLogEntries());
        });
      }

      if (clearLogButton) {
        clearLogButton.addEventListener('click', () => {
          logEntries = [];
          renderLogEntries();
          showCommandFeedback('Cleared live log history', 'info');
        });
      }

      document.addEventListener('admin:broadcast-command', event => {
        metricState.commandsBroadcast += 1;
        refreshMetrics();
      });

      document.addEventListener('admin:selected-command', event => {
        metricState.commandsTargeted += 1;
        refreshMetrics();
      });

      document.addEventListener('mqtt:connect-requested', event => {
        startMqttClient(event.detail || {});
      });

      document.addEventListener('mqtt:config-cleared', () => {
        stopMqttClient();
        teamCardMap = {};
        if (teamListEl) {
          teamListEl.innerHTML = '';
        }
        teamEmptyEl = null;
        ensureTeamsPlaceholder();
        accentIndex = 0;
        resetMetricState();
        updateTeamCount();
        updateOnlineCount();
        updateWatchlist();
      });

      getAllTeamCards().forEach(registerTeamCard);

      updateOnlineCount();
      updateTeamCount();
      updateWatchlist();
      renderLogEntries();
      ensureTeamsPlaceholder();
    });
  </script>
</body>
</html>
